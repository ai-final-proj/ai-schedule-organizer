#!/usr/bin/env sh
set -e

# Generate a .env file from environment variables (e.g., Hugging Face Secrets)
# By default, capture the common keys this app uses. Override with ENV_KEYS.
ENV_PATH="/app/.env"
KEYS=${ENV_KEYS:-"SECRET_KEY DATABASE_URL PORT"}

echo "# Generated by docker-entrypoint.sh" > "$ENV_PATH"
for key in $KEYS; do
  val=$(printenv "$key")
  if [ -n "$val" ]; then
    # Escape any embedded newlines
    printf "%s=%s\n" "$key" "$val" >> "$ENV_PATH"
  fi
done

# Apply DB migrations (works for SQLite or external DB via DATABASE_URL)
if command -v alembic >/dev/null 2>&1; then
  alembic upgrade head || echo "[warn] Alembic migration failed; proceeding to start app"
fi

exec "$@"

